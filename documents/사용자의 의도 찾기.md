## :woman_technologist: 어떤 태그가 사용자의 의도에 가장 부합할까?

`크리스마스에 듣기 좋은 재즈 플레이리스트`에서 `크리스마스, 듣기좋은, 재즈, 플레이리스트` 태그가 추출되었다고 하자.

각각의 embedding을 그저 더해서 title embedding을 생성해야 할까?

어쩌면 `크리스마스, 재즈`가 가장 중요한 단어(즉 사용자의 의도에 맞는 단어)가 아닐까?

그렇다면 사용자의 의도에 맞는 단어를 어떻게 뽑아낼 수 있을까?

<br></br>

base line 구현을 다 하고난 후에 만난 문제는 <<색이 뚜렷하지 않은 태그 때문에 이상한 결과가 출력된다!>> 였다.

vocab에 있는 태그를 적절히 잘 찾아내기는 하는데, `듣기좋은` , `노래` , `가끔` 과 같은 태그들이 embedding 방향을 바꾸게 되면서 엉뚱한 결과가 나왔다.

이러한 태그를 직접 찾아 일일이 제거하는 것보다는 규칙을 만들어 걸러내고 싶어졌다.

"어떻게 하면 중요하지 않은 태그를 버릴 수 있을까?"

<br></br>

## 방법 1. 가장 유사하지 않은 태그를 버리자.

#### 가설 : 쓸데 없는 태그는 다른 태그와 유사하지 않을거야!

`청량한 여름에 딱인 노래들`을 입력하면 `청량한, 여름, 노래`이 추출된다.

`청량한`과 `여름`은 노래 추출에 의미가 있는 태그들이다. 두 embedding은 아마 적당히 비슷한 방향으로 학습이 되었을 것이다.

그러나 `노래` 태그는 `청량한`과도 유사하지 않고 `여름`과도 유사하지 않다. 즉 현재 query에서 그리 중요한 태그가 아니다.

<br></br>

위 가설에 따라, noise인 `노래`를 거르기 위해 다음 과정을 거친다.

1. 추출된 N개의 태그에서 (N combination 2)개의 쌍을 생성하고 cosine similarity를 계산한다.

   ```python
   > Similarity : [(0.7004, ('청량한', '여름')), (0.1135, ('청량한', '듣고싶은노래')), (0.1503, ('여름', '듣고싶은노래'))]
   ```

2. 유사도가 0.1보다 낮은 태그 쌍을 1차적으로 제거한다.

   * 모두 0.1 이상이므로 제거 없이 잰항한다.

3. 남은 태그쌍을 이용하여 0.3분위수를 계산하고 threshold 이하인 경우에 해당 태그 쌍을 제거한다.

   ```python
   > Threshold : 0.2896 # 0.3분위수 계산
   > Filtered tags : ['청량한', '여름'] # 그 중 threshold를 넘은 태그 쌍
   ```

4. 남은 태그 쌍만을 이용하여 노래 추천에 사용한다.

   ```python
   > Filtered tags : ['청량한', '여름'] # 그 중 threshold를 넘은 태그 쌍
   > Recommended tags  : ['시원한', '더위', '청량', '여름노래', '해변', '휴가', '시원', '바캉스', '무더위', '청량감']
   ```

<br></br>

#### 단점 : 쓸데없는 태그가 더 많은 경우에는 제대로 걸러내지 못한다.

`비오는날 듣고 싶은 플레이 리스트` 에서 `비오는날, 듣고, 싶은, 플레이, 리스트` 가 추출된다.

`비오는날`이 가장 중요한 태그가 되어야 하지만 `듣고, 싶은`의 simliarity가 높기 때문에 걸러지지 않고 남아있게 된다.

```python
> Similarity : [(0.3218, ('비오는날', '듣기')), (0.3101, ('비오는날', '좋은')), (0.3548, ('비오는날', '발라드')),
                (0.1540, ('비오는날', '모음')), (0.9181, ('듣기', '좋은')), (0.10513, ('듣기', '발라드')),
                (0.5167, ('듣기', '모음')), (0.1709, ('좋은', '발라드')), (0.5153, ('좋은', '모음')), (0.2413, ('발라드', '모음'))]
> threshold : 0.3491
> Filtered tags : ['듣기', '비오는날', '발라드', '모음', '좋은']
```

<br></br>

## 방법 2. 색이 뚜렷하지 않은 태그를 거를 수 있는 새로운 지표를 정의한다.

플레이 리스트 생성에 중요한 역할을 하지 않는 태그, 걸러내야만 하는 태그들의 공통점이 무엇일까 골똘히 생각해 보았다.

`듣고, 싶은, 좋은, 모음, 노래` 등 ... 

내가 캐치해낸 이들의 공통점은 바로 **"어떤 태그와 붙여놓아도 어색하지 않은 태그"**였다.

이 태그들은 `힙합, 아이돌, 재즈, 발라드, 비오는날` 등 어떤 태그와 붙여놓아도 크게 어색하지 않다.

그렇다면? <u>함께 자주 등장한 태그 목록</u>과, <u>embedding이 유사한 태그 목록</u>이 아주 많이 달라질 것이다!

1. 색이 뚜렷한 태그일 수록 동시 등장 단어와 유사 단어의 topk가 겹칠 것이다.
2. 색이 뚜렷하지 않은 태그일 수록 겹치지 않을 것이다.

<br></br>

#### :raising_hand: 한번 EDA 해보자!

##### `드라이브`

`기분전환, 신나는, 여행`은 `드라이브`와 함께 자주 등장하면서 유사한 태그이다.

```python
> 동시 등장 : [('기분전환', 4467), ('신나는', 2924), ('여행', 2466), ('노래', 2147), ('감성', 2110), ('좋은', 1686)]
> 유사 단어 : [('기분전환', '0.800'), ('신나는', '0.684'), ('여행', '0.668'), ('유산소운동', '0.618')]
```



##### `노래`

`좋은, 듣는`과 함께 등장하지만 유사하지는 않다.

```python
> 동시 등장 : [('좋은', 5337), ('듣는', 3752), ('기분전환', 3552), ('감성', 3440), ('듣기', 3303), ('잔잔한', 3111)]
> 유사 단어 : [('노래들', '0.651'), ('기분전환', '0.579'), ('해줄게', '0.570'), ('노래모음', '0.557'), ('노래가', '0.554')]
```



##### `모음`

`노래, 감성, 발라드` 와 자주 등장하지만, 유사하지는 않다.

```python
> 동시 등장 : [('노래', 2747), ('감성', 1749), ('발라드', 1661), ('좋은', 1545), ('잔잔한', 1227), ('기분전환', 1134)]
> 유사 단어 : [('명곡', '0.539'), ('역대', '0.462'), ('명곡들', '0.442'), ('및', '0.438'), ('잔잔한', '0.435')]
```

<br></br>

#### :raising_hand_man: 이를 기반으로 consistency라는 지표를 정의해보자.

일관성이 없는 태그일 수록, 동시 등장 빈도가 높은 단어와 멀어질 것이라고 생각하였다.

태그의 일관성을 나타내는 지표인 `consistency`를 다음과 같이 정의한다.

1. 동시 등장 빈도가 높은 단어순으로 정렬한다.
2. topk(여기서는 3을 선택했다.)를 골라, 현재 태그와의 cosine simliarity를 계산한다.
3. simliarity의 평균을 구한다.
4. `consistency := exp(simliarity_mean*5)` 를 계산한다.
   * exp를 이용해서 similarity의 평균이 클 수록 지수적으로 증가하게 만들었다.

<br></br>

* #### 일관성 있는 태그들

  ##### `드라이브`

  `드라이브`는 같이 자주 등장한 태그인 `기분전환, 신나는, 여행`과 평균 유사도 `0.71` 를 가진다. 일관성 점수는 36.1점

  ```python
  > 동시 등장 태그와의 유사도 : [('기분전환', 0.7999042), ('신나는', 0.6840602), ('여행', 0.66783154)]
  > mean : 0.7172
  > consistency : 36.1012
  ```

  

  ##### `여행`

  ```python
  > 동시 등장 태그와의 유사도 : [('드라이브', 0.66783154), ('기분전환', 0.6004468), ('산책', 0.7333313)]
  > mean : 0.6672032276789347
  > consistency : 28.106929247954454
  ```

  

  ##### `잔잔한`

  ```python
  > 동시 등장 태그와의 유사도 : [('감성', 0.65588707), ('휴식', 0.7101877), ('노래', 0.35525125)]
  > mean : 0.5737753311793009
  > consistency : 17.617216883367615
  ```

  <br></br>

* #### 일관성이 부족한 태그들

  ##### `모음`

  `모음`은 같이 자주 등장한 태그인 `노래, 감성, 발라드`와 평균 유사도 `0.30`을 가진다. 일관성 점수는 4.5점

  ```python
  > 동시 등장 태그와의 유사도 : [('노래', 0.30135116), ('감성', 0.38351822), ('발라드', 0.22662774)]
  > mean : 0.3038
  > consistency : 4.5683
  ```

  

  ##### `플레이 리스트`

  ```python
  > 동시 등장 태그와의 유사도 : [('감성', 0.26516274), ('기분전환', 0.17730048), ('팝', 0.29602396)]
  > mean : 0.24616239468256632
  > consistency : 3.424008611827372
  ```

  

  ##### `음악`

  ```python
  > 동시 등장 태그와의 유사도 : [('듣는', 0.40693295), ('좋은', 0.22431634), ('뉴에이지', 0.43810493)]
  > mean : 0.3564514070749283
  > consistency : 5.943255429627285
  ```

<br></br>

#### :tipping_hand_woman: 지표 평가하기

내가 만든 지표인 consistency의 성능을 정량적으로 평가하기 위한 방법을 생각해보다가, playlist continuation에 적용시켜보기로 했다.

1. word2vec으로 song, tag embedding을 학습한다.
2. query playlist에 대해
   1. bm25 점수를 이용하여 embedding들을 weighted sum한 후 추천해본다.
   2. song과 tag의 consistency를 이용하여 embedding을 weighted sum한 후 추천해본다.
3. 두 모델의 성능을 비교해본다.

<br></br>

bm25는 널리 쓰이는 검색 랭킹 알고리즘으로, playlist continuation에서 다음과 같은 준수한 성능을 보여주었다.

```python
# bm25

Music nDCG: 0.223942
Tag nDCG: 0.483925
Score: 0.26294
```

그런데 ! `consistency` 를 적용한 모델이 `bm25`를 적용한 모델의 점수와 비슷하다!

그래서 나는 consistency를 이용해서 태그들의 무게를 조정하는 작업이 꽤 괜찮은 방법이라고 판단하였다 ㅎㅎ

```python
# consistency

Music nDCG: 0.212127
Tag nDCG: 0.482843
Score: 0.252734
```

<br></br>

#### :tipping_hand_man: 무게 조정을 얼마나 잘 하는지 구경해보자!

플레이리스트, 노래만, 차곡차곡, 모음 등의 태그 점수가 상대적으로 낮은 것을 확인할 수 있다 !

```python
편집샵 주인장 플레이리스트 훔쳐왔다 !!!!

> tag and consistency : [('편집샵', 19.5696), ('주인', 7.2085), ('플레이리스트', 3.8408), ('왔다', 3.4428)]
> Recommended tags    : ['매장음악', '트렌디', '감각적인', '매장', '옷가게', '세련된', '팝', '기분전환', '힙스터', '느낌있는', '감성', '편집숍', '힙한']
```

```python
청량한 남돌 노래만 차곡차곡!

> tag and consistency : [('청량한', 11.5398), ('남돌', 33.1995), ('노래만', 4.0467), ('차곡차곡', 3.9376)]
> Recommended tags    : ['아이돌', '남자아이돌', '신나는', '댄스', '보이그룹', '기분전환', '여름', '청량', '수록곡', '아이돌의숨은명곡', '숨은명곡', '댄스곡', 'kpop']
```

```python
틀어놓기만 해도 해변가 드라이브 중 ~

> tag and consistency : [('틀어놓기만', 6.3394), ('해도', 7.6859), ('해변가', 11.6214), ('드라이브', 38.232)]
> Recommended tags    : ['여름', '기분전환', '신나는', '여행', '스트레스', '산책', '봄', '팝', '가을', '바다', '매장음악', '트로피컬', '카페', '드라이브음악']
```

```python
둠칫둠칫 내적 댄스 유발하는 노래 모음

> tag and consistency : [('둠칫둠칫', 13.027), ('내적', 24.2422), ('댄스', 12.404), ('유발', 14.0877), ('하는', 3.5657), ('노래', 14.455), ('모음', 6.524)]
> Recommended tags    : ['내적댄스', '신나는', '기분전환', '드라이브', '운동', '내적댄스유발', '그루브', '흥폭발', '스트레스', '팝송', '흥', '노동요', 'Pop', '아이돌']
```

